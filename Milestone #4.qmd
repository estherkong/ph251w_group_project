---
title: "Milestone #4 for Infectious Disease Outbreak"
author: "Carli Boyd, Esther Kong, Pamela Pichon"
date: Nobember 20, 2025
format: html
editor: visual
---

---

```{r}

#Load required packages
library(tidyverse)

```

## Dataset 1: Simulated Novel Infection Disease case reporting for California

We can assume that the data source is simulated data of infectious disease cases for each county in California reported from public health agencies and organizations such as county health departments during 2023.

Our research question explores if the current outbreak is disproportionately affecting certain demographic or geographic populations to inform departments and agencies how to allocate prevention and treatment resources.

```{r}
sim_novelid_CA <- read_csv("https://raw.githubusercontent.com//PHW290/phw251_projectdata/main/scenario_1/sim_novelid_CA.csv")



```

## Dataset 2: Simulated Novel Infectious Disease case reporting for Los Angeles County

Description of the dataset:

This is a simulated dataset containing reported cases of a disease categorized by date of diagnoses, patient demographics, and cumulative totals for infected, unrecovered, and severe cases, for the county of Los Angeles.

Relation of data to problem statement:

The data provides patient demographics of age group, binary gender, race and ethnicity which will help to answer if there are disparities in the rate of infection among different populations.

```{r}
#| warning: false
#| message: false
la_county_cases <- read.csv(
  "https://raw.githubusercontent.com//PHW290/phw251_projectdata/main/scenario_1/sim_novelid_LACounty.csv")

# Column names were updated to lower case below and reassigned to a new object
la_county_cases <- la_county_cases
names(la_county_cases) <- tolower(names(la_county_cases))


```

## Dataset 3: California estimated population for 2023

Desription of dataset: This dataset is simulated, but approximates what population data from the State of California might look like. It includes population estimates by the CA Dept of Finance for 2023 by CA county and demographic categories (age, race, and sex).

Relation of data to problem statement: This population dataset provides information on the general Californian population which can be stratified according to the demographic or geographic categories of interest, which will be useful for standardizing between groups for comparison.

```{r}
#| warning: false
#| message: false
#import the dataset and assign to an object
filepath_ca_pop_2023 <- "https://raw.githubusercontent.com/PHW290/phw251_projectdata/main/scenario_1/ca_pop_2023.csv"
ca_pop_2023 <- read_csv(filepath_ca_pop_2023)



#quick summary of population numbers (summed up the rows) across race and age groups
ca_pop_2023 |> 
  group_by(race7, age_cat) |> 
  summarise(
    count = n(),
    total = sum(pop)
  )

```

## Data element descriptions:

From Dataset 1:

-   time_int: contains numeric values. This represents the standard 7-day period (Sunday to Saturday) used by the Centers for Disease Control and Prevention (CDC) to report public health data. The format is YYYY+\<2-digit MMWR week and ranges from 202322 to 202352.

-   new_infections: is numeric data and shows the number of new infections or cases in a specific county and belonging to other demographics category. The maximum number of new infection is 7142.

-   new_severe: is numeric data and shows newly identified individuals that need to be hospitalized due to severe cases. The maximum number of individuals is 198.

From Dataset 3:

-   health_officer_region: contains character data, unique values of "Bay Area", "Greater Sierra Sacramento","Central California", "Rural North", "Southern California", "Los Angeles". It aggregates counties into more general buckets.

-   age_cat: contains character data, with unique values "0-4", "5-11", "12-17", "18-49", "50-64", "65+". These haven't been set up as ordered levels yet.

-   sex: character data with only two unique values "FEMALE" and "MALE".

-   race7: contains character data, with values that correspond to race category codes (according to the codebook). Unique values are: "WhiteTE NH" "Black NH" "AIAN NH" "Asian NH" "NHPI NH" "MR NH" "Hispanic". These correspond to the following:\
    WhiteTE NH = White, Non-Hispanic; Black NH = Black, Non-Hispanic;AIAN NH = American Indian or Alaska Native, Non-Hispanic; Asian NH = Asian, Non-Hispanic; NHPI NH = Native Hawaiian or Pacific Islander, Non-Hispanic; MR NH = Multiracial (two or more of above races), Non-Hispanic; Hispanic = Hispanic (any race)

-   pop: contains numeric data which indicate the number of people in each strata. Mean, median, and range from this column:\
    Mean 433.9\
    Median 15.0\
    Range 0.0 to 45227.0

# Milestone #3

## Morbidity data sets (CA and LA County)

### Cleaning

```{r}
# recode column names, values, or formats that are in discordant (dates, etc.)

# renaming column names and dates to match across all 3 datasets 
la_county_clean <-la_county_cases %>% rename(
  race_ethnicity = race_eth,
  diagnosis_date = dt_dx
) %>% mutate(
  diagnosis_date = dmy(diagnosis_date)
)

# updated column names to match the novelid_CA set
la_county_clean <- la_county_clean %>% rename(
  cumulative_infected = infected_cumulative,
  new_severe = severe_new,
  cumulative_severe = severe_cumulative
)

# there isnt a county column in the la_county set so I added one
la_county_clean <- la_county_clean %>%
  mutate(county = "Los Angeles")

# dropped dt_report column, added the epi week column, and put in the same order
la_county_clean <- la_county_clean %>% select(
  -dt_report) %>% mutate(
    epi_week = epiweek(diagnosis_date),
    new_infections = dx_new
  ) %>% select(
    county,
    diagnosis_date,
    epi_week,
    age_category,
    sex,
    race_ethnicity,
    new_infections,
    cumulative_infected,
    new_severe,
    cumulative_severe
  )


# checking the column names and date format
head(la_county_clean)

# renaming column names to match across all 3 datasets 
novelid_clean <- sim_novelid_CA %>% rename(
  age_category = age_cat,
  diagnosis_date = dt_diagnosis
) %>% mutate(
  diagnosis_date = ymd(diagnosis_date)
) 

# recoding the race and ethnicity from integers to the actual category to match
novelid_clean <- novelid_clean %>% mutate(
  race_ethnicity = case_when(
    race_ethnicity == 1 ~ "White, Non-Hispanic",
    race_ethnicity == 2 ~ "Black, Non-Hispanic",
    race_ethnicity == 3 ~ "American Indian or Alaska Native, Non-Hispanic",
    race_ethnicity == 4 ~ "Asian, Non-Hispanic",
    race_ethnicity == 5 ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
    race_ethnicity == 6 ~ "Multiracial (two or more of above races), Non-Hispanic",
    race_ethnicity == 7 ~ "Hispanic (any race)",
    race_ethnicity == 9 ~ "Unknown",
    TRUE ~ NA_character_  
  )
)
# Convert time_int to epi week number and reordered the columns to be consistent
novelid_clean <- novelid_clean %>%
  mutate(epi_week = as.integer(substr(time_int, 5, 6))) %>%
  select(
    county,
    diagnosis_date,
    epi_week,
    age_category,         
    sex,
    race_ethnicity,
    new_infections,
    cumulative_infected,
    new_severe,
    cumulative_severe
  )

# remove the word "County" from county names for joining with pop dataset
novelid_clean$county <- gsub(" County","",novelid_clean$county)

# checking the column names and dates
head(novelid_clean)
```

### Joining

```{r}
# checking whether all the column names match
identical(names(la_county_clean),names(novelid_clean))

# combine morbidity datasets into a single data set
morbidity_combined <- bind_rows(la_county_clean, novelid_clean)

str(morbidity_combined)
```

### Summarising Strata of Interest

```{r}
# Select demographic and geographic strata(s) of interest:
# Grouping by county and then by race/ethnicity

stratified_morbidity_infections <- morbidity_combined %>% 
  group_by(county, race_ethnicity) %>% 
  summarise("new infections" = sum(new_infections),
            "new severe" = sum(new_severe)) %>% 
  ungroup()

head(stratified_morbidity_infections)

```

## Population data set

### Cleaning

```{r}

# renamed columns to match the morbidity data sets

ca_pop_clean<- ca_pop_2023 %>% rename(
  race_ethnicity = race7,
  age_category = age_cat
)

unique(ca_pop_2023$age_cat)

# recoding the race_ethnicity to match across all the data sets

ca_pop_clean <- ca_pop_clean %>% mutate(
  race_ethnicity = case_when(
    race_ethnicity == "WhiteTE NH" ~ "White, Non-Hispanic",
    race_ethnicity == "Black NH" ~ "Black, Non-Hispanic",
    race_ethnicity == "AIAN NH" ~ "American Indian or Alaska Native, Non-Hispanic",
    race_ethnicity == "Asian NH" ~ "Asian, Non-Hispanic",
    race_ethnicity == "NHPI NH" ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
    race_ethnicity == "MR NH" ~ "Multiracial (two or more of above races), Non-Hispanic",
    race_ethnicity == "Hispanic" ~ "Hispanic (any race)",
    TRUE ~ NA_character_
  )
)


# combining the first 3 age categories because the other two data sets are 0-17 and this one is 0-4, 5-11, and 12-17

ca_pop_clean <- ca_pop_clean %>% mutate(
  age_category = case_when(
    age_category %in% c("0-4", "5-11", "12-17") ~ "0-17",
    TRUE ~ NA_character_
  )
)

#removing health_officer_region 
ca_pop_clean <- ca_pop_clean %>%
  select(-health_officer_region)

# checking column names
head(ca_pop_clean)
```

## Joining Morbidity & Population

```{r}
#sum up the rows in ca_pop_clean to get proper stratified populations for join

stratified_ca_pop <- ca_pop_clean %>%
  group_by(county, race_ethnicity) %>% 
  summarize(pop = sum(pop)) %>% 
  ungroup()

#join the two stratified data sets 

all_three_joined <- left_join(stratified_morbidity_infections,
                              stratified_ca_pop, 
                              by = c("county","race_ethnicity"))

head(all_three_joined)

#check for NAs
check_na <- all_three_joined %>% 
  filter(if_any(everything(), is.na))

```

## Stratified Per Capita Infection Rates

```{r}

#per capita rate metric per county & race

stratified_rate_infections <- all_three_joined %>%
  group_by(county, race_ethnicity) %>% 
  mutate(`new_infections_per_capita` = (`new infections` / `pop`)*100,
         severe_infections_per_capita = (`new severe`/`pop`)*100) %>% 
  ungroup()

#per capita rate metric per county

rate_infections_per_county <- stratified_rate_infections %>%
  group_by(county) %>% 
  summarize(infections = sum(`new infections`),
            pop = sum(pop)) %>%
  mutate(`county_infection_rate` = (`infections` / `pop`)*100) %>% 
  ungroup()

# check for NAs
sum(is.na(stratified_rate_infections$new_infections_per_capita))
sum(is.na(stratified_rate_infections$severe_infections_per_capita))
any(is.na(rate_infections_per_county$county_infection_rate))

# replace the NaNs with 0
stratified_rate_infections[is.na(stratified_rate_infections)] <- 0

```

## Data Dictionary on Clean Dataset

```{r}

library(tibble)

data_dictionary <- tribble(
  ~variable, ~description, ~type, ~units_or_values, ~notes,
  # Core identifiers
  "county", "California county", "character", "Text string", 
  "Matches county boundaries; 'Los Angeles' added manually",
  "diagnosis_date", "Date of diagnosis", "date", "YYYY-MM-DD", 
  "Converted with lubridate (dmy/ymd)", "epi_week", "Epidemiologic week number",
  "integer", "1â€“53", "Derived from diagnosis_date or time_int",
  # Demographics
  "age_category", "Age group category", "Character", "e.g., '0-17', '18-49', 
  '50+'", "Recoded to align across datasets", "sex", "Sex of case", "Character",
  "Male/Female", "N/A", "race_ethnicity", "Race/ethnicity group", "Character",
  "Standardized categories (White, Black, Asian, etc.)",
  "Recoded from integers or abbreviations",
  # Morbidity counts
  "new_infections", "Number of new infections", "numeric", "Count",
  "from dx_new or summed across strata", "cumulative_infected",
  "Number of Cumulative infections to date", "numeric", "count",
  "Renamed from infected_cumulative", "new_severe",
  "Number of new severe infections", "numeric", "Count",
  "Renamed from severe_new", "cumulative_severe", 
  "Number of Cumulative severe infections to date", "numeric", "Count", 
  "Renamed from severe_cumulative",
  # Population
  "pop", "Population denominator for strata", "numeric", "Count",
  "Summed from ca_pop_clean by county * race_ethnicity",
  # Derived rates
  "new_infections_per_capita", "New infections per capita", "numeric", 
  "Cases per 100 persons", "Calculated as new_infections / pop * 100",
  "severe_infections_per_capita", "Severe infections per capita", "numeric", 
  "Cases per 100 persons", "Calculated as new_severe / pop * 100",
  "county_infection_rate", "Overall infection rate per county", "numeric", 
  "Cases per 100 persons", "Calculated as infections / pop * 100",
  # Summary statistics
  "mean_infections_per_capita", "Mean infection rate across counties", "numeric",
  "Cases per 100 persons", "Grouped by race_ethnicity",
  "median_infections_per_capita", "Median infection rate across counties",
  "numeric", "Cases per 100 persons", "Grouped by race_ethnicity",
  "min_infections_per_capita", "Minimum infection rate across counties", 
  "numeric", "Cases per 100 persons", "Grouped by race_ethnicity",
  "max_infections_per_capita", "Maximum infection rate across counties", 
  "numeric", "Cases per 100 persons", "Grouped by race_ethnicity",
  "mean_severe_per_capita", "Mean severe infection rate across counties", 
  "numeric", "Cases per 100 persons", "Grouped by race_ethnicity",
  "severe_ratio_pct", "Severe-to-infection ratio", "numeric", "Percentage (%)",
  "Rate of newly identified severe cases per capita divided by the rate of new
  infections per capita. This reflects the relative burden of severe disease 
  compared to the overal infection incidence, not the proportion of infections
  that are severe "
)

data_dictionary
```

## Descriptive Statistics

```{r}

# DEscriptive statistics table to ask if there are racial disparities in infections
summary_table <- stratified_rate_infections %>%
  group_by(race_ethnicity) %>%
  summarise(
    mean_infections_per_capita = mean(new_infections_per_capita, na.rm = TRUE),
    median_infections_per_capita =median(new_infections_per_capita, na.rm = TRUE),
    min_infections_per_capita = min(new_infections_per_capita, na.rm = TRUE),
    max_infections_per_capita = max(new_infections_per_capita, na.rm = TRUE),
    mean_severe_per_capita = mean(severe_infections_per_capita, na.rm = TRUE),
    severe_ratio_pct= (mean_severe_per_capita / mean_infections_per_capita) * 100
  ) %>% arrange(
    desc(severe_ratio_pct)
  )
summary_table
```
