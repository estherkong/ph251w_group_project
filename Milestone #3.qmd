---
title: "Milestone #3 for Infectious disease outbreak"
author: "Carli Boyd, Esther Kong, Pamela Pichon"
date: 'today'
editor: visual
format: html
---

```{r}
#| results: 'hide'
 
#Load required packages
library(tidyverse)

```

## Dataset 1: Simulated Novel Infection Disease case reporting for California

We can assume that the data source is simulated data of infectious disease cases for each county in California reported from public health agencies and organizations such as county health departments during 2023.

Our research question explores if the current outbreak is disproportionately affecting certain demographic or geographic populations to inform departments and agencies how to allocate prevention and treatment resources.

```{}
```

## Dataset 2: Simulated Novel Infectious Disease case reporting for Los Angeles County

Description of the dataset:

This is a simulated dataset containing reported cases of a disease categorized by date of diagnoses, patient demographics, and cumulative totals for infected, unrecovered, and severe cases, for the county of Los Angeles.

Relation of data to problem statement:

The data provides patient demographics of age group, binary gender, race and ethnicity which will help to answer if there are disparities in the rate of infection among different populations.

```{r}
#| code-overflow: wrap
# The dataset was imported using read.csv from the class github and assigned to an object
novelid_LAcounty <- read.csv(
  "https://raw.githubusercontent.com//PHW290/phw251_projectdata/main/scenario_1/sim_novelid_LACounty.csv")

# Column names were updated to lower case below and reassigned to a new object
la_county_cases <- novelid_LAcounty
names(la_county_cases) <- tolower(names(la_county_cases))

names(la_county_cases)

#Understanding the range of severe cases in each demographic area would be useful. Before we can get the ranges, we need to determine the data types

str(la_county_cases)
# the data elements are all classified as they should be

# We need to know the different race/ethnicity groups in the dataset
unique(la_county_cases$race_eth)

# This gives us "White, Non-Hispanic", "Black, Non-Hispanic", "American Indian or Alaska Native, Non-Hispanic", "Asian, Non-Hispanic", "Native Hawaiian or Pacific Islander, Non-Hispanic", "Multiracial (two or more of above races), Non-Hispanic" and "Hispanic (any race)"

# Then we can summarize each grouping to get the number of cases per group and the range and average of new severe cases.

la_county_cases %>% group_by(
  race_eth) %>%
  summarise(
    count = n(),
    severe_new_min = min(severe_new, na.rm = T),
    severe_new_max = max(severe_new, na.rm = T),
    severe_new_mean = mean(severe_new, na.rm = T),
    severe_cumulative_mean = mean(severe_cumulative, na.rm = T)
)

# It would be a good idea to remove the column dt_report as part of cleaning as this column only contains NA values. 
```

## Dataset 3: California estimated population for 2023

Desription of dataset: This dataset is simulated, but approximates what population data from the State of California might look like. It includes population estimates by the CA Dept of Finance for 2023 by CA county and demographic categories (age, race, and sex).

Relation of data to problem statement: This population dataset provides information on the general Californian population which can be stratified according to the demographic or geographic categories of interest, which will be useful for standardizing between groups for comparison.

```{r}
#| code-overflow: wrap
#import the dataset and assign to an object
filepath_ca_pop_2023 <- "https://raw.githubusercontent.com/PHW290/phw251_projectdata/main/scenario_1/ca_pop_2023.csv"
ca_pop_2023 <- read_csv(filepath_ca_pop_2023)

#see data types for each column
str(ca_pop_2023)

#check for any NA values in the dataset
any(is.na(ca_pop_2023))

#see the unique values for some columns
unique(ca_pop_2023$health_officer_region)
unique(ca_pop_2023$age_cat)
unique(ca_pop_2023$race7)

#mean, median, range for pop column
summary(ca_pop_2023$pop)

#quick summary of population numbers (summed up the rows) across race and age groups
ca_pop_2023 |> 
  group_by(race7, age_cat) |> 
  summarise(
    count = n(),
    total = sum(pop)
  )

# Most variables are currently character fields, but to properly manipulate them, it will make sense to convert them to factors. eg. county, health_officer_region, age_cat, sex, and race. Also a number of these character fields are inconsistently capitalized, so we'd likely want to standardise all the data. age_cat would also likely be more useful if set up as an ordered factor.

# There also appear to be rows of data where all demographic and geographic values are the same, but have different population estimates listed. These may represent collection of count data from individual areas within each geographic area, stratified by age, so these fields will require combining to give one population number estimate per geographic area per demographic group.
```

## Data element descriptions:

From Dataset 1:

-   time_int: contains numeric values. This represents the standard 7-day period (Sunday to Saturday) used by the Centers for Disease Control and Prevention (CDC) to report public health data. The format is YYYY+\<2-digit MMWR week and ranges from 202322 to 202352.

-   new_infections: is numeric data and shows the number of new infections or cases in a specific county and belonging to other demographics category. The maximum number of new infection is 7142.

-   new_severe: is numeric data and shows newly identified individuals that need to be hospitalized due to severe cases. The maximum number of individuals is 198.

From Dataset 3:

-   health_officer_region: contains character data, unique values of "Bay Area", "Greater Sierra Sacramento","Central California", "Rural North", "Southern California", "Los Angeles". It aggregates counties into more general buckets.

-   age_cat: contains character data, with unique values "0-4", "5-11", "12-17", "18-49", "50-64", "65+". These haven't been set up as ordered levels yet.

-   sex: character data with only two unique values "FEMALE" and "MALE".

-   race7: contains character data, with values that correspond to race category codes (according to the codebook). Unique values are: "WhiteTE NH" "Black NH" "AIAN NH" "Asian NH" "NHPI NH" "MR NH" "Hispanic". These correspond to the following:\
    WhiteTE NH = White, Non-Hispanic; Black NH = Black, Non-Hispanic;AIAN NH = American Indian or Alaska Native, Non-Hispanic; Asian NH = Asian, Non-Hispanic; NHPI NH = Native Hawaiian or Pacific Islander, Non-Hispanic; MR NH = Multiracial (two or more of above races), Non-Hispanic; Hispanic = Hispanic (any race)

-   pop: contains numeric data which indicate the number of people in each strata. Mean, median, and range from this column:\
    Mean 433.9\
    Median 15.0\
    Range 0.0 to 45227.0

# Milestone #3

## Morbidity data sets (CA and LA County)

```{r}
## Carli 
# recode column names, values, or formats that are in discordant (dates, etc.)
# I saved these as new objects so that I wouldn't overwrite existing data
# We can change the code once confirmed all correct

library(dplyr)
library(lubridate)
# renaming column names and dates to match across all 3 datasets 
la_county_clean <-la_county_cases %>% rename(
  race_ethnicity = race_eth,
  diagnosis_date = dt_dx
) %>% mutate(
  diagnosis_date = dmy(diagnosis_date)
)

# updated column names to match the novelid_CA set
la_county_clean <- la_county_clean %>% rename(
  cumulative_infected = infected_cumulative,
  new_unrecovered = unrecovered_new,
  cumulative_unrecovered = unrecovered_cumulative,
  new_severe = severe_new,
  cumulative_severe = severe_cumulative
)

# there isnt a county column in the la_county set so I added one
la_county_clean <- la_county_clean %>%
  mutate(county = "Los Angeles County")

# dropped the dt_report column, added the epi week column, and put in the same order
la_county_clean <- la_county_clean %>% select(
  -dt_report) %>% mutate(
    epi_week = epiweek(diagnosis_date),
    new_infections = dx_new
  ) %>% select(
    county,
    diagnosis_date,
    epi_week,
    age_category,
    sex,
    race_ethnicity,
    new_infections,
    cumulative_infected,
    new_unrecovered,
    cumulative_unrecovered,
    new_severe,
    cumulative_severe
  )


# checking the column names and date format
head(la_county_clean)



# renaming column names to match across all 3 datasets 
novelid_clean <- sim_novelid_CA %>% rename(
  age_category = age_cat,
  diagnosis_date = dt_diagnosis
) %>% mutate(
  diagnosis_date = ymd(diagnosis_date)
) 



# recoding the race and ethnicity from integers to the actual category to match
novelid_clean <- novelid_clean %>% mutate(
  race_ethnicity = case_when(
    race_ethnicity == 1 ~ "White, Non-Hispanic",
    race_ethnicity == 2 ~ "Black, Non-Hispanic",
    race_ethnicity == 3 ~ "American Indian or Alaska Native, Non-Hispanic",
    race_ethnicity == 4 ~ "Asian, Non-Hispanic",
    race_ethnicity == 5 ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
    race_ethnicity == 6 ~ "Multiracial (two or more of above races), Non-Hispanic",
    race_ethnicity == 7 ~ "Hispanic (any race)",
    race_ethnicity == 9 ~ "Unknown",
    TRUE ~ NA_character_  
  )
)
# Convert time_int to epi week number and reordered the columns to be consistent
novelid_clean <- novelid_clean %>%
  mutate(epi_week = as.integer(substr(time_int, 5, 6))) %>%
  select(
    county,
    diagnosis_date,
    epi_week,
    age_category,         
    sex,
    race_ethnicity,
    new_infections,
    cumulative_infected,
    new_unrecovered,
    cumulative_unrecovered,
    new_severe,
    cumulative_severe
  )


# checking the column names and dates
head(novelid_clean)
```

```{r}
# combine morbidity datasets into a single data set
morbidity_combined <- left_join(x=novelid_clean, y=la_county_clean, by="county")

#test

```

```{r}
# Select demographic and geographic strata(s) of interest
# which demographics do we want? maybe by age group?

```

```{r}
# aggregate the data into a new dataframe to include only one row per strata of interest


```

## Population data set

```{r}

# renamed columns to match the morbidity data sets

ca_pop_clean<- ca_pop_2023 %>% rename(
  race_ethnicity = race7,
  age_category = age_cat
)

# recoding the race_ethnicity to match across all the data sets

ca_pop_clean <- ca_pop_clean %>% mutate(
  race_ethnicity = case_when(
    race_ethnicity == "WhiteTE NH" ~ "White, Non-Hispanic",
    race_ethnicity == "Black NH" ~ "Black, Non-Hispanic",
    race_ethnicity == "AIAN NH" ~ "American Indian or Alaska Native, Non-Hispanic",
    race_ethnicity == "Asian NH" ~ "Asian, Non-Hispanic",
    race_ethnicity == "NHPI NH" ~ "Native Hawaiian or Pacific Islander, Non-Hispanic",
    race_ethnicity == "MR NH" ~ "Multiracial (two or more of above races), Non-Hispanic",
    race_ethnicity == "Hispanic" ~ "Hispanic (any race)",
    TRUE ~ NA_character_
  )
)
  

# combining the first 3 age categories because the other two data sets are 0-17 and this one is 0-4, 5-11, and 12-17

ca_pop_clean <- ca_pop_clean %>% mutate(
  age_category = case_when(
    age_category %in% c("0-4", "5-11", "12-17") ~ "0-17",
    TRUE ~ NA_character_
  )
)


# checking column names
head(ca_pop_clean)
```
